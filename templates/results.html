<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“Š Results â€“ InstruNet AI</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<!-- ================= TOP NAV BAR ================= -->
<div class="top-nav">
  <div class="nav-left">ðŸŽµ <b>InstruNet AI</b></div>
  <div class="nav-links">
    <a href="/home">Home</a>
    <a href="/analysis">Analysis</a>
    <a href="/results" class="active">Results</a>
    <a href="/history">History</a>
    <a href="/about">About</a>
  </div>
</div>
<!-- ================= END TOP NAV ================= -->

<div class="app">

  <!-- HEADER -->
  <div class="header">
    <h1>ðŸ“Š Results & Evaluation</h1>
    <p>Model performance metrics and spectrogram visualization</p>
  </div>

  <!-- GRID -->
  <div class="grid" style="grid-template-columns: 1.1fr 2.2fr;">

    <!-- LEFT COLUMN -->
    <div class="card left">

      <!-- METRICS -->
      <div class="panel">
        <h3 class="panel-title">Evaluation Metrics (Test Dataset)</h3>

        <div class="bars" id="metrics">
          <div class="bar">
            <span>Accuracy <b id="acc">â€“</b></span>
            <div><i style="width:0%"></i></div>
          </div>
          <div class="bar">
            <span>Precision <b id="prec">â€“</b></span>
            <div><i style="width:0%"></i></div>
          </div>
          <div class="bar">
            <span>Recall <b id="rec">â€“</b></span>
            <div><i style="width:0%"></i></div>
          </div>
          <div class="bar">
            <span>F1 Score <b id="f1">â€“</b></span>
            <div><i style="width:0%"></i></div>
          </div>
        </div>

        <p style="margin-top:10px;font-size:13px;color:#94a3b8;">
          Metrics computed during offline evaluation on the IRMAS test set
        </p>
      </div>

      <!-- NOTES (MOVED BELOW METRICS) -->
      <div class="panel" style="margin-top:18px;">
        <h3 class="panel-title">Notes</h3>
        <ul class="detected">
          <li>âœ” Spectrogram reflects CNN input features</li>
          <li>âœ” Metrics are fixed (test evaluation)</li>
          <li>âœ” Results page is read-only</li>
        </ul>
      </div>

    </div>

    <!-- RIGHT COLUMN: MEL SPECTROGRAM -->
    <!-- RIGHT COLUMN -->
<div class="card center">
  <div class="panel analysis-box">

    <!-- ðŸ”¥ DETECTED INSTRUMENTS
    {% if detected %}
    <div style="margin-bottom:20px;">
      <h3 class="panel-title">Detected Instruments</h3>

      {% for inst, prob in detected %}
        <div style="font-size:14px; margin-bottom:6px;">
          {% if loop.index <= 2 %}
            â­ {{ inst }} â€“ {{ "%.1f"|format(prob * 100) }}%
          {% else %}
            âœ” {{ inst }} â€“ {{ "%.1f"|format(prob * 100) }}%
          {% endif %}
        </div>
      {% endfor %}
    </div>
    {% endif %} -->

    <!-- Mel Spectrogram -->
    <h3 class="panel-title">Mel Spectrogram</h3>

<div style="text-align:center;">

  <div class="waveform-box">
    <img
      id="melImage"
      style="
        width:100%;
        height:350px;
        object-fit:contain;
        border-radius:16px;
        background:#000;
        padding:10px;
        display:none;
      "
    />
    <p id="melSongName" class="mel-song-name"></p>
  </div>

{% if mel_filename %}
<div class="mel-download-wrap">
  <a href="/download_mel/{{ mel_filename }}"
     class="export-btn">
     ðŸ“¥ Download Mel Spectrogram
  </a>
</div>
{% endif %}


</div>


        <!-- <p style="
  margin-top:14px;
  font-size:13px;
  color:#94a3b8;
  text-align:center;
">

          Mel spectrogram generated from uploaded audio (model input)
        </p> -->
      </div>
    </div>

  </div>
</div>

<script>
  const selectedFile = "{{ audio_path | default('') }}";
/* ================= LOAD METRICS ================= */
const metrics = {
  accuracy: 0.91,
  precision: 0.89,
  recall: 0.88,
  f1: 0.885
};

function setMetric(id, value){
  document.getElementById(id).textContent =
    (value * 100).toFixed(1) + "%";

  document
    .getElementById(id)
    .parentElement
    .nextElementSibling
    .querySelector("i")
    .style.width = (value * 100) + "%";
}

setMetric("acc", metrics.accuracy);
setMetric("prec", metrics.precision);
setMetric("rec", metrics.recall);
setMetric("f1", metrics.f1);

/* ================= LOAD REAL MEL ================= */
function loadRealMel() {

  // 1ï¸âƒ£ If coming from History page
  if (selectedFile && selectedFile !== "None") {

    fetch("/mel_spectrogram", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        filename: selectedFile.replace("uploads/", "")
      })
    })
    .then(r => r.json())
    .then(d => {
      if (d.error) return;
      const img = document.getElementById("melImage");
      img.src = "data:image/png;base64," + d.image;
      img.style.display = "block";

      function cleanName(name) {
  const file = name.replace("uploads/", "");
  const parts = file.split("_");
  parts.shift(); // remove UUID
  return parts.join("_");
}

document.getElementById("melSongName").innerText =
cleanName(selectedFile);


    });

    return;
  }

  // 2ï¸âƒ£ If coming from live analysis
  const saved = sessionStorage.getItem("instruNet_last_analysis");
  if (!saved) return;

  const parsed = JSON.parse(saved);

  fetch("/mel_spectrogram", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ filename: parsed.filename })
  })
  .then(r => r.json())
  .then(d => {
    if (d.error) return;
    const img = document.getElementById("melImage");
    img.src = "data:image/png;base64," + d.image;
    img.style.display = "block";
    document.getElementById("melSongName").innerText =
cleanName(parsed.filename);


  });
}

document.addEventListener("DOMContentLoaded", loadRealMel);
</script>

</body>
</html>
